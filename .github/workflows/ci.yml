name: CI/CD –¥–ª—è –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä–∞

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  test:
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        python-version: [3.8, 3.9, 3.10]

    steps:
    - name: üì• Checkout –∫–æ–¥
      uses: actions/checkout@v4

    - name: üêç –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}

    - name: üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–∏–Ω—Ç–∞–∫—Å–∏—Å–∞
      run: |
        python -m py_compile app.py
        python -m py_compile tests.py
        python -m py_compile modules/calculator.py
        python -m py_compile modules/history.py

    - name: üß™ –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤
      run: |
        python tests.py

    - name: üìä –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç—á–µ—Ç–∞ —Ç–µ—Å—Ç–æ–≤
      run: |
        echo "## –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è" >> $GITHUB_STEP_SUMMARY
        echo "‚úÖ –í—Å–µ —Ç–µ—Å—Ç—ã —É—Å–ø–µ—à–Ω–æ –≤—ã–ø–æ–ª–Ω–µ–Ω—ã –¥–ª—è Python ${{ matrix.python-version }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**–î–µ—Ç–∞–ª–∏:**" >> $GITHUB_STEP_SUMMARY
        echo "- –ù–∏—Å—Ö–æ–¥—è—â–µ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ: ‚úÖ –ü—Ä–æ–π–¥–µ–Ω–æ" >> $GITHUB_STEP_SUMMARY
        echo "- –í–æ—Å—Ö–æ–¥—è—â–µ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ: ‚úÖ –ü—Ä–æ–π–¥–µ–Ω–æ" >> $GITHUB_STEP_SUMMARY
        echo "- –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫: ‚úÖ –ü—Ä–æ–π–¥–µ–Ω–æ" >> $GITHUB_STEP_SUMMARY

  integration-test:
    runs-on: ubuntu-latest
    needs: test
    
    steps:
    - name: üì• Checkout –∫–æ–¥
      uses: actions/checkout@v4

    - name: üêç –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
      run: |
        pip install -r requirements.txt

    - name: üöÄ –ó–∞–ø—É—Å–∫ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω–æ–≥–æ —Ç–µ—Å—Ç–∞
      run: |
        # –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–µ—Å—Ç—ã –≤ —Ñ–æ–Ω–æ–≤–æ–º —Ä–µ–∂–∏–º–µ
        python tests.py > test_results.log 2>&1
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ —Ç–µ—Å—Ç—ã –∑–∞–≤–µ—Ä—à–∏–ª–∏—Å—å —É—Å–ø–µ—à–Ω–æ
        if grep -q "–¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï –ó–ê–í–ï–†–®–ï–ù–û" test_results.log; then
          echo "‚úÖ –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ—à–ª–∏ —É—Å–ø–µ—à–Ω–æ"
          cat test_results.log
        else
          echo "‚ùå –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ–≤–∞–ª–∏–ª–∏—Å—å"
          cat test_results.log
          exit 1
        fi

    - name: üìã –ü—É–±–ª–∏–∫–∞—Ü–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
      uses: actions/upload-artifact@v3
      with:
        name: test-results
        path: test_results.log

  deploy-notification:
    runs-on: ubuntu-latest
    needs: [test, integration-test]
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
    
    steps:
    - name: üì¢ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—à–Ω–æ–º –¥–µ–ø–ª–æ–µ
      run: |
        echo "üöÄ –í—Å–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ–π–¥–µ–Ω—ã! –ö–æ–¥ –≥–æ—Ç–æ–≤ –∫ –¥–µ–ø–ª–æ—é."
        echo "üìÖ $(date)" 
        echo "üîß –°–æ–±—ã—Ç–∏–µ: ${{ github.event_name }}"
        echo "üéØ –í–µ—Ç–∫–∞: ${{ github.ref }}"
        echo "üë§ –ê–≤—Ç–æ—Ä: ${{ github.actor }}"